#textdomain wesnoth-Conquest

[multiplayer]
	id=Conquest_Pasarganta
	name=_"Conquest Pasarganta"
	# wmllint: local spellings >300 TP Liquergue Algernon Catoh Gagarna Torath Samrock Burgoth Surdmark
	description= _"For 2-6 players. This is a map pack of its own. Different areas of this map can be played.
Look at the village numbers below to see the size of the map." + "

" + _"<b>Check the »Custom Options« tab to choose the map section.</b>" + "
" + _"
Pasarganta - biggest map (>300) TP
Surdmark - southern half (181) TP
Liquergue - eastern half (150) TP
Algernon - northern half (120)
Catoh - western half (150)

Gagarna - south-west (90)
Torath - south-east (90)
Samrock - north-east (60)
Burgoth - north-west (60)"
	# Using this as initial map because it displays nice 100x100 as dimensions.
	map_file=~add-ons/Conquest_Asterisk/maps/pasarganta/pasarganta.map
	{OBJECTIVES_NOTE_MAP_BY _"Map by Lich_Lord and Blop" (SUBMAP=summary=$mapsection) }
	{SCENARIO_MACROS}
	[options]
		{OPTIONS_FOR_ALL_MAPS MIN=25 THEME=10}
		{OPTIONS_FOR_AI}
		[choice]
			id=teleports
			default=tunnel
			name=_"Teleports" + " " + _"(Pasarganta, Surdmark, Liquergue only)"
			description=_"Teleports change the map shape to a toroid on Surdmark and Pasarganta and to a ring on Liquergue." + "

" + _ "Tunnels is what is used on the Poland map.

Tunnels + Teleports will in addition teleport the unit when moving <i>directly</i> onto the rune. There are corner cases where movement costs to use the teleportation rune or the tunnel method to reach the other side are different.

The next method will keep it simple and deal 150 damage if a unit is standing <i>on the rune hex</i> at the other side, while the last method will harm <i>multiple</i> units.

Ingame will not be shown which method is used!"
			[item]
				# po: no tunnels
				name=_"Disabled"
				value=no
			[/item]
			[item]
				name=_"Tunnels"
				value=tunnel
			[/item]
			[item]
				name=_"Tunnels + Teleports"
				value=teleport
			[/item]
			[item]
				name=_"Tunnels + Damage"
				value=damage
			[/item]
			[item]
				name=_"Tunnels + Splash"
				value=splash
			[/item]
		[/choice]
		[choice]
			id=mapvariant
			name= _ "Section of the map"
			description=""
			default=pasarganta_new
			[item]
				# Map version 2.4 by Blop.
				name=_"Pasarganta (biggest map, tunnels)" # 100x100
				value="pasarganta_new"
				# Leaders: extra space.
			[/item]
			[item]
				name=_"Surdmark (southern half, tunnels)" #100x56
				value="surdmark"
				# Using fake map border (or void) would be better than the transition between real map border and the cave walls.
			[/item]
			[item]
				name=_"Liquergue (eastern half, tunnels)" # 50x109
				value="liquergue"
				# Leaders when using TP: in the free space.
				# Leaders otherwise: extra free space.
			[/item]
			[item]
				name=_"Algernon (northern half)" # 100x44
				value="algernon"
				# Leaders: in mountains
			[/item]
			[item]
				name=_"Catoh (western half)" # 50x100
				value="catoh"
				# Using fake map border (or void) would be better than the transition between real map border and the cave walls.
			[/item]
			[item]
				name=_"Gagarna (south-west)" # 50x56
				value="gagarna"
				# Using fake map border (or void) would be better than the transition between real map border and the cave walls.
			[/item]
			[item]
				name=_"Torath (south-east)"  # 50x56
				value="torath"
				# Leaders: box in east.
			[/item]
			[item]
				name=_"Samrock (north-east)" # 50x44
				value="samrock"
				# Leaders: extra space.
			[/item]
			[item]
				name=_"Burgoth (north-west)" # 50x44
				value="burgoth"
				# Leaders: in mountains.
			[/item]
			[item]
				name=_"Former Pasarganta (biggest map)" # 100x100
				value="pasarganta"
				# Leaders: in mountains.
			[/item]
		[/choice]
	[/options]
	[load_resource]
		id=Conquest_mechanism
	[/load_resource]

	{RECRUIT_UNIT_MENU (
		{HUMAN_RECRUITS    *^Vh,*^Vhc,*^Vht}
		{ELVES_RECRUITS    *^Ve*}
		{ORCS_RECRUITS     *^Vc}
		{DWARVES_RECRUITS  *^Vu,*^Vhh}
		{DRAKES_RECRUITS   *^Vd,*^Vka}
		{UNDEAD_RECRUITS   *^Vhs*}
		{MERFOLK_RECRUITS  *^Vm*}
		{DUNEFOLK_RECRUITS *^Vdt,*^Vct,*^Vda}
	)}

	# This event creates a tunnels variable used by capitol mode.
	# Actually tunnels are created near the end of the file.
	[event]
		name=preload
		fist_time_only=no
		[lua]
			name=pasarganta_new_lua_tunnel
			code=<<
local _ = wesnoth.textdomain 'wesnoth-Conquest'

if wml.variables.mapvariant == 'pasarganta_new' then
	tunnels = {}
	table.insert(tunnels, { {x=1,y=22}, {x=100,y=34}, _'east',  _'west',  'rune1' })

	table.insert(tunnels, { {x=30,y=1}, {x=24,y=100}, _'south', _'north', 'rune2' })

	table.insert(tunnels, { {x=71,y=1}, {x=81,y=100}, _'south', _'north', 'rune3' })

	table.insert(tunnels, { {x=1,y=70}, {x=100,y=66}, _'east',  _'west',  'rune4' })

elseif wml.variables.mapvariant == 'liquergue' then
	tunnels = {}
	table.insert(tunnels, { {x=4,y=4},  {x=2,y=105},  _'south', _'north', 'rune1' })

	table.insert(tunnels, { {x=29,y=3}, {x=25,y=108}, _'south', _'north', 'rune4' })

	table.insert(tunnels, { {x=49,y=2}, {x=46,y=108}, _'south', _'north', 'rune6' })

elseif wml.variables.mapvariant == 'surdmark' then
	tunnels = {}
	table.insert(tunnels, { {x=49,y=2}, {x=49,y=56},  _'south', _'north', 'rune1' })

	table.insert(tunnels, { {x=2,y=3},  {x=2,y=50},   _'south', _'north', 'rune4' })

	table.insert(tunnels, { {x=92,y=3}, {x=100,y=43}, _'south', _'north', 'rune6' })

	table.insert(tunnels, { {x=2,y=26}, {x=98,y=28},  _'east',  _'west',  'rune2' })

	table.insert(tunnels, { {x=4,y=1},  {x=89,y=2},   _'east',  _'west',  'rune3' })

	table.insert(tunnels, { {x=8,y=52}, {x=99,y=54},  _'east',  _'west',  'rune5' })
end
>>
		[/lua]
	[/event]

	[event]
		name=prestart

		[store_unit]
			[filter]
				canrecruit=yes
			[/filter]
			variable=leaders
			kill=yes
		[/store_unit]

		# When starting the game from command line, the map variant from [option] will be unset.
		# Adding a fallback here:
		[lua]
			name="fallback map"
			code=<<
if wml.variables.mapvariant == nil then
	wml.variables.mapvariant = mathx.random_choice{'samrock', 'torath', 'burgoth', 'gagarna'}
end
>>
		[/lua]

		[switch]
			variable=mapvariant

			# Using map_data instead of map_file because of bug #9177.
			[case]
				value=surdmark
				[if]
					{VARIABLE_CONDITIONAL teleports not_equals no}
					[then]
						[replace_map]
							shrink=yes
							expand=yes
							map_data="{~add-ons/Conquest_Asterisk/maps/surdmark_telep_short.map}"
						[/replace_map]
					[/then]
					[else]
						[replace_map]
							shrink=yes
							expand=yes
							map_data="{~add-ons/Conquest_Asterisk/maps/pasarganta/surdmark.map}"
						[/replace_map]
					[/else]
				[/if]
			[/case]

			[case]
				value=liquergue
				[if]
					{VARIABLE_CONDITIONAL teleports not_equals no}
					[then]
						[replace_map]
							shrink=yes
							expand=yes
							map_data="{~add-ons/Conquest_Asterisk/maps/pasarganta/liquergue_telep.map}"
						[/replace_map]
					[/then]
					[else]
						[replace_map]
							shrink=yes
							expand=yes
							map_data="{~add-ons/Conquest_Asterisk/maps/pasarganta/liquergue.map}"
						[/replace_map]
					[/else]
				[/if]
			[/case]

			[case]
				value=algernon
				[replace_map]
					shrink=yes
					expand=yes
					map_data="{~add-ons/Conquest_Asterisk/maps/pasarganta/algernon.map}"
				[/replace_map]
			[/case]

			[case]
				value=catoh
				[replace_map]
					shrink=yes
					expand=yes
					map_data="{~add-ons/Conquest_Asterisk/maps/pasarganta/catoh.map}"
				[/replace_map]
			[/case]

			[case]
				value=gagarna
				[replace_map]
					shrink=yes
					expand=yes
					map_data="{~add-ons/Conquest_Asterisk/maps/pasarganta/gagarna.map}"
				[/replace_map]
			[/case]

			[case]
				value=torath
				[replace_map]
					shrink=yes
					expand=yes
					map_data="{~add-ons/Conquest_Asterisk/maps/pasarganta/torath.map}"
				[/replace_map]
			[/case]

			[case]
				value=samrock
				[replace_map]
					shrink=yes
					expand=yes
					map_data="{~add-ons/Conquest_Asterisk/maps/pasarganta/samrock.map}"
				[/replace_map]
			[/case]

			[case]
				value=burgoth
				[replace_map]
					shrink=yes
					expand=yes
					map_data="{~add-ons/Conquest_Asterisk/maps/pasarganta/burgoth.map}"
				[/replace_map]
			[/case]

			[case]
				value=pasarganta_new
				[replace_map]
					shrink=yes
					expand=yes
					map_data="{~add-ons/Conquest_Asterisk/maps/pasarganta/pasarganta_new.map}"
				[/replace_map]
			[/case]
		[/switch]


		# Place leaders onto new starting position.
		# This code fails if the map has no starting positions for them.
		[foreach]
			array=leaders
			[do]
				[unstore_unit]
					variable=this_item
					location_id=$this_item.side
				[/unstore_unit]
			[/do]
		[/foreach]

		{CLEAR_VARIABLE leaders}

		{CE_SLOWTHINKER_TO_ENCLAVE_CONVERT}

		[switch]
			variable=mapvariant

			# BURGOTH-Villages (north-west)
			[case]
				value=burgoth,algernon,catoh,pasarganta
				{VARIABLE CE_SYSTEM.offset_y -6}
				{~add-ons/Conquest_Asterisk/regions/burgoth.rgs}
			[/case]


			# SAMROCK-Villages (north-east)
			[case]
				value=samrock,liquergue
				{VARIABLE CE_SYSTEM.offset_y -1}
			[/case]
			[case]
				value=algernon,pasarganta
				{VARIABLE CE_SYSTEM.offset_x 50}
				{VARIABLE CE_SYSTEM.offset_y -6}
			[/case]
			[case]
				value=samrock,algernon,liquergue,pasarganta
				{~add-ons/Conquest_Asterisk/regions/samrock.rgs}
			[/case]


			# GARGANA-Villages (south-west)
			[case]
				value=catoh,pasarganta
				{VARIABLE CE_SYSTEM.offset_x 0}
				{VARIABLE CE_SYSTEM.offset_y 44}
			[/case]
			[case]
				value=gagarna,catoh,pasarganta
				{~add-ons/Conquest_Asterisk/regions/gagarna.rgs}
			[/case]


			# TORATH-Villages (south-east)
			[case]
				value=liquergue
				{VARIABLE CE_SYSTEM.offset_y 49}
			[/case]
			[case]
				value=pasarganta
				{VARIABLE CE_SYSTEM.offset_x 50}
				{VARIABLE CE_SYSTEM.offset_y 44}
			[/case]
			[case]
				value=torath,liquergue,pasarganta
				{~add-ons/Conquest_Asterisk/regions/torath.rgs}
			[/case]


			# Extra handling
			[case]
				value=surdmark
				{VARIABLE CE_SYSTEM.offset_x -4}
				{VARIABLE CE_SYSTEM.offset_y -2}
				{~add-ons/Conquest_Asterisk/regions/surdmark_long_telep.rgs}
			[/case]


			# FIX BONUS AND LABELS FOR REGIONS COMBINED FROM DIFFERENT MAPS
			[case]
				value=algernon,liquergue,catoh,pasarganta
				[lua]
					name=fix_bonus_function
					code=<<
function conquest_fix_labels( region_id, region_bonus )
	local villages = wml.variables['CE_SYSTEM.regions_'..region_id..'.length']
	local first_village = wml.variables['CE_SYSTEM.regions_'..region_id]
	local first_label = wesnoth.map.get_label { x = first_village.x, y = first_village.y }

	for j=0,villages-1,1 do

		local village = wml.variables['CE_SYSTEM.regions_'..region_id..'['..j..']']
		local old_text = tostring(wesnoth.map.get_label { x = village.x, y = village.y }.text)
		local text_end = string.find(old_text, '+' )
		local new_text = string.sub(old_text, 1, text_end) .. region_bonus .. ')'

		wesnoth.map.add_label {
			text = new_text,
			color = first_label.color,
			x = village.x,
			y = village.y,
			visible_in_fog = first_label.visible_in_fog
		}
	end
end
>>
				[/lua]
			[/case]

			# Fix bonus for overlapping region
			[case]
				value=algernon
				[lua]
					name=algernon_fix_bonus
					code=<<
for i=0,wml.variables['CE_SYSTEM.regions.length']-1,1 do
	if wml.variables['CE_SYSTEM.regions['..i..'].id'] == 'Yarghford' then
		wml.variables['CE_SYSTEM.regions['..i..'].bonus'] = 7
		conquest_fix_labels('Yarghford', 7)
	elseif wml.variables['CE_SYSTEM.regions['..i..'].id'] == 'Trileka' then
		wml.variables['CE_SYSTEM.regions['..i..'].bonus'] = 10
		conquest_fix_labels('Trileka', 10)
	elseif wml.variables['CE_SYSTEM.regions['..i..'].id'] == 'Zimyar' then
		wml.variables['CE_SYSTEM.regions['..i..'].bonus'] = 6
		conquest_fix_labels('Zimyar', 6)
	end
end
>>
				[/lua]
			[/case]

			[case]
				value=liquergue
				# Yarghford Mountains to 5
				[lua]
					name=liquergue_fix_bonus
					code=<<
for i=0,wml.variables['CE_SYSTEM.regions.length']-1,1 do
	if wml.variables['CE_SYSTEM.regions['..i..'].id'] == 'Yarghford' then
		wml.variables['CE_SYSTEM.regions['..i..'].bonus'] = 5
		conquest_fix_labels('Yarghford', 5)
		break
	end
end
>>
				[/lua]
			[/case]

			[case]
				value=catoh
				# Yarghford Mountains to 7
				# Carolas to 7
				[lua]
					name=catoh_fix_bonus
					code=<<
for i=0,wml.variables['CE_SYSTEM.regions.length']-1,1 do
	if wml.variables['CE_SYSTEM.regions['..i..'].id'] == 'Yarghford' then
		wml.variables['CE_SYSTEM.regions['..i..'].bonus'] = 7
		conquest_fix_labels('Yarghford', 7)
	elseif wml.variables['CE_SYSTEM.regions['..i..'].id'] == 'Carolas' then
		wml.variables['CE_SYSTEM.regions['..i..'].bonus'] = 7
		conquest_fix_labels('Carolas', 7)
	end
end
>>
				[/lua]
			[/case]

			[case]
				value=pasarganta
				{VARIABLE CE_SYSTEM.offset_x 0}
				{VARIABLE CE_SYSTEM.offset_y 0}
				[region]
					name=New Calron
					bonus=11
					village_list=Caithur,51,67
				[/region]
				# Yarghford Mountains to 15
				# Barca to 12
				# New Calron to 11 and a new village Caithur,51,67
				# Trileka to 10
				# Carolas to 7
				# Zimyar to 6
				[lua]
					name=pasarganta_fix_bonus
					code=<<
for i=0,wml.variables['CE_SYSTEM.regions.length']-1,1 do
	if wml.variables['CE_SYSTEM.regions['..i..'].id'] == 'Yarghford' then
		wml.variables['CE_SYSTEM.regions['..i..'].bonus'] = 15
		conquest_fix_labels('Yarghford', 15)
	elseif wml.variables['CE_SYSTEM.regions['..i..'].id'] == 'Barca' then
		wml.variables['CE_SYSTEM.regions['..i..'].bonus'] = 12
		conquest_fix_labels('Barca', 12)
	elseif wml.variables['CE_SYSTEM.regions['..i..'].id'] == 'New_Calron' then
		wml.variables['CE_SYSTEM.regions['..i..'].bonus'] = 11
		conquest_fix_labels('New_Calron', 11)
	elseif wml.variables['CE_SYSTEM.regions['..i..'].id'] == 'Trileka' then
		wml.variables['CE_SYSTEM.regions['..i..'].bonus'] = 10
		conquest_fix_labels('Trileka', 10)
	elseif wml.variables['CE_SYSTEM.regions['..i..'].id'] == 'Carolas' then
		wml.variables['CE_SYSTEM.regions['..i..'].bonus'] = 7
		conquest_fix_labels('Carolas', 7)
	elseif wml.variables['CE_SYSTEM.regions['..i..'].id'] == 'Zimyar' then
		wml.variables['CE_SYSTEM.regions['..i..'].bonus'] = 6
		conquest_fix_labels('Zimyar', 6)
	end
end
>>
				[/lua]
			[/case]

#define TUNNEL FROM_X FROM_Y RUNE TO_X TO_Y LABEL
	# 1st solution: [tunnel]
	# - is usable by AI
	# - allows vision to the other side
	[tunnel]
		[filter][/filter]
		[source]
			x={FROM_X}
			y={FROM_Y}
		[/source]
		[target]
			x={TO_X}
			y={TO_Y}
			radius=1
		[/target]
		bidirectional=no
	[/tunnel]
	{SET_LABEL {FROM_X} {FROM_Y} {LABEL}}
	{PLACE_IMAGE scenery/{RUNE}.png {FROM_X} {FROM_Y}}


	[switch]
		variable=teleports
		[case]
			value=teleport

			# 2nd solution: moveto [event]
			# - places unit even when tunnel is blocked.
			[event]
				name=moveto
				first_time_only=no
				[filter]
					x={FROM_X}
					y={FROM_Y}
				[/filter]

				[if]
					[lua]
						name=movecheck
						# Mixing preprocessor instructions and Lua here.
						code="
local u = wesnoth.units.get(wesnoth.current.event_context.x1, wesnoth.current.event_context.y1)
local m = 0
local blocked = wesnoth.units.get({TO_X},{TO_Y})
if blocked then
	m = wesnoth.units.movement_on(u, wesnoth.current.map[{LEFT_BRACE}{TO_X},{TO_Y}{RIGHT_BRACE}])
end
wml.variables.required_moves = m
if u.moves >= m then
	return true
else
	return false
end
"
					[/lua]
					[then]
						# When using the [tunnel], moving to the other end is a normal move which cost some movement points.
						# When teleporting not. To have them behave the same we reduce the moves manually.
						[modify_unit]
							[filter]
								x={FROM_X}
								y={FROM_Y}
							[/filter]
							moves="$($this_unit.moves - $required_moves)"
						[/modify_unit]
						[teleport]
							[filter]
								x={FROM_X}
								y={FROM_Y}
							[/filter]
							x={TO_X}
							y={TO_Y}
							animate=no
						[/teleport]
						# Corner case: If the unit landed on another hex, we might have subtracted too less MP.
					[/then]
					[else]
						[if]
							[variable]
								name=required_moves
								less_than=99
							[/variable]
							[then]
								[floating_text]
									x={FROM_X}
									y={FROM_Y}
									text="<span color='#cccc33'>" + _ "Too less moves" + "</span>"
								[/floating_text]
							[/then]
							[else]
								[floating_text]
									x={FROM_X}
									y={FROM_Y}
									text="<span color='#cccc33'>" + _ "Unreachable" + "</span>"
								[/floating_text]
							[/else]
						[/if]
						[allow_undo][/allow_undo]
					[/else]
				[/if]
				{CLEAR_VARIABLE required_moves}
			[/event]
		[/case]

		[case]
			value=damage

			[event]
				name=moveto
				first_time_only=no
				[filter]
					x={FROM_X}
					y={FROM_Y}
				[/filter]

				[if]
					[have_unit]
						x={TO_X}
						y={TO_Y}
						[filter_side]
							[enemy_of]
								side=$side_number
							[/enemy_of]
						[/filter_side]
						[not]
							status=pretrified
						[/not]
					[/have_unit]
					[then]
						[harm_unit]
							[filter]
								x={TO_X}
								y={TO_Y}
							[/filter]
							amount=150
							kill=yes
							animate=defender
						[/harm_unit]
					[/then]
					[else]
						[allow_undo][/allow_undo]
					[/else]
				[/if]
			[/event]
		[/case]

		[case]
			value=splash

			[event]
				name=moveto
				first_time_only=no
				[filter]
					x={FROM_X}
					y={FROM_Y}
				[/filter]

				[if]
					[have_unit]
						[filter_location]
							x={TO_X}
							y={TO_Y}
							radius=1
						[/filter_location]
						[filter_side]
							[enemy_of]
								side=$side_number
							[/enemy_of]
						[/filter_side]
						[not]
							status=pretrified
						[/not]
					[/have_unit]
					[then]
						[harm_unit]
							[filter]
								[filter_location]
									x={TO_X}
									y={TO_Y}
									radius=1
								[/filter_location]
								[filter_side]
									[enemy_of]
										side=$side_number
									[/enemy_of]
								[/filter_side]
								[not]
									status=pretrified
								[/not]
							[/filter]
							amount=150
							kill=yes
							animate=defender
						[/harm_unit]
					[/then]
					[else]
						[allow_undo][/allow_undo]
					[/else]
				[/if]
			[/event]
		[/case]
	[/switch]
#enddef

			[case]
				value=algernon
				{VARIABLE mapsection _"Algernon-section"}
			[/case]
			[case]
				value=catoh
				{VARIABLE mapsection _"Catoh-section"}
			[/case]
			[case]
				value=gagarna
				{VARIABLE mapsection _"Gagarna-section"}
				{PLACE_IMAGE items/altar.png 46 59}
			[/case]
			[case]
				value=torath
				{VARIABLE mapsection _"Torath-section"}
			[/case]
			[case]
				value=samrock
				{VARIABLE mapsection _"Samrock-section"}
			[/case]
			[case]
				value=burgoth
				{VARIABLE mapsection _"Burgoth-section"}
			[/case]
			[case]
				value=pasarganta
				{VARIABLE mapsection _"Complete map"}
			[/case]
			[case]
				value=pasarganta_new
				[if]
					{VARIABLE_CONDITIONAL teleports equals no}
					[then]
						{VARIABLE mapsection _"New map variant"}
					[/then]
					[else]
						{VARIABLE mapsection _"New map variant with teleports"}

						{TUNNEL 1 22 rune1 100 34 _"east"}
						{TUNNEL 100 34 rune1 1 22 _"west"}

						{TUNNEL 30 1 rune2 24 100 _"south"}
						{TUNNEL 24 100 rune2 30 1 _"north"}

						{TUNNEL 75 1 rune3 81 100 _"south"}
						{TUNNEL 81 100 rune3 75 1 _"north"}

						{TUNNEL 1 70 rune4 100 66 _"east"}
						{TUNNEL 100 66 rune4 1 70 _"west"}
					[/else]
				[/if]
			[/case]

			[case]
				value=surdmark
				[if]
					{VARIABLE_CONDITIONAL teleports equals no}
					[then]
						{VARIABLE mapsection _"Surdmark-section"}
					[/then]
					[else]
						{VARIABLE mapsection _"Surdmark-section with teleports"}

						{TUNNEL 49 2 rune1 49 56 _"south"}
						{TUNNEL 49 56 rune1 49 2 _"north"}

						{TUNNEL 2 3 rune4 2 50 _"south"}
						{TUNNEL 2 50 rune4 2 3 _"north"}

						{TUNNEL 92 3 rune6 100 43 _"south"}
						{TUNNEL 100 43 rune6 92 3 _"north"}

						{TUNNEL 2 26 rune2 98 28 _"east"}
						{TUNNEL 98 28 rune2 2 26 _"west"}

						{TUNNEL 4 1 rune3 89 2 _"east"}
						{TUNNEL 89 2 rune3 4 1 _"west"}

						{TUNNEL 8 52 rune5 99 54 _"east"}
						{TUNNEL 99 54 rune5 8 52 _"west"}
					[/else]
				[/if]
			[/case]
			[case]
				value=liquergue
				[if]
					{VARIABLE_CONDITIONAL teleports equals no}
					[then]
						{VARIABLE mapsection _"Liquergue-section"}
					[/then]
					[else]
						{VARIABLE mapsection _"Liquergue-section with teleports"}

						{TUNNEL 4 4 rune1 2 105 _"south"}
						{TUNNEL 2 105 rune1 4 4 _"north"}

						{TUNNEL 29 3 rune4 25 108 _"south"}
						{TUNNEL 25 108 rune4 29 3 _"north"}

						{TUNNEL 49 2 rune6 46 108 _"south"}
						{TUNNEL 46 108 rune6 49 2 _"north"}
					[/else]
				[/if]
			[/case]

			# Torath has a leader-box. Make it smaller if the last places are empty.
			[case]
				value=torath

				[if]
					[not]
						[have_unit]
							side=6
						[/have_unit]
					[/not]
					[then]
						[terrain]
							terrain=Wo
							x=48-51
							y=12-13
						[/terrain]
						[terrain]
							terrain=Wo^_fme
							x=49-51
							y=11
						[/terrain]
						[terrain]
							terrain=^_fme
							layer=overlay
							x=49-51
							y=10
						[/terrain]
						# Can make it even smaller if player 5 is not used either.
						[if]
							[not]
								[have_unit]
									side=5
								[/have_unit]
							[/not]
							[then]
								[terrain]
									terrain=Wo
									x=48-51
									y=10-11
								[/terrain]
								[terrain]
									terrain=Wo^_fme
									x=49-51
									y=9
								[/terrain]
								[terrain]
									terrain=^_fme
									layer=overlay
									x=49-51
									y=8
								[/terrain]
								# If player 4 is left empty as well.
								[if]
									[not]
										[have_unit]
											side=4
										[/have_unit]
									[/not]
									[then]
										[terrain]
											terrain=Wo
											x=48-51
											y=8-9
										[/terrain]
										[terrain]
											terrain=Wo^_fme
											x=49-51
											y=7
										[/terrain]
										[terrain]
											terrain=^_fme
											layer=overlay
											x=49-51
											y=6
										[/terrain]
										# When only the first places are in use.
										[if]
											[not]
												[have_unit]
													side=3
												[/have_unit]
											[/not]
											[then]
												[terrain]
													terrain=Wo
													x=48-51
													y=6-7
												[/terrain]
												[terrain]
													terrain=Wo^_fme
													x=49-51
													y=5
												[/terrain]
												[terrain]
													terrain=^_fme
													layer=overlay
													x=49-51
													y=4
												[/terrain]
												[remove_shroud]
													x,y=51,5
												[/remove_shroud]
												[lift_fog]
													x,y=51,5
													multiturn=yes
												[/lift_fog]
											[/then]
											[else]
												# Avoid strange corner.
												[remove_shroud]
													x,y=51,7
												[/remove_shroud]
												[lift_fog]
													x,y=51,7
													multiturn=yes
												[/lift_fog]
											[/else]
										[/if]
									[/then]
									[else]
										# Avoid strange corner 4p mode.
										[remove_shroud]
											x,y=51,9
										[/remove_shroud]
										[lift_fog]
											x,y=51,9
											multiturn=yes
										[/lift_fog]
									[/else]
								[/if]
							[/then]
							[else]
								# Avoid strange corner 5p mode.
								[remove_shroud]
									x,y=51,11
								[/remove_shroud]
								[lift_fog]
									x,y=51,11
									multiturn=yes
								[/lift_fog]
							[/else]
						[/if]
					[/then]
					[else]
						# Avoid strange corner 6p mode.
						[remove_shroud]
							x,y=51,13
						[/remove_shroud]
						[lift_fog]
							x,y=51,13
							multiturn=yes
						[/lift_fog]
					[/else]
				[/if]
			[/case]

		[/switch]

		# This code has two use cases:
		# - on pasarganta_new, define regions and place village labels as usual.
		# - on others, recolor the previously placed village labels.
		# It works, because the regions of all mapvariants do also exist in pasarganta.rgs.
		# Needs to be here, after the other labels werde added;
		# It uses the mapsection and mapvariant variables to detect the recoloring-mode.
		{~add-ons/Conquest_Asterisk/regions/pasarganta.rgs}

		{CLEAR_VARIABLE mapvariant,CE_SYSTEM.offset_x,CE_SYSTEM.offset_y}
	[/event]

[/multiplayer]

#undef TUNNEL
